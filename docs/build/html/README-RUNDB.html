
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>solar-coronal-inversion repository on github &#8212; solar-coronal-inversion update-readthedocs documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Module Overview Schematic" href="module_overview.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>README for running CLE database calculations on multiple CPU threads.</p>
<section id="solar-coronal-inversion-repository-on-github">
<h1><a class="reference external" href="https://github.com/arparaschiv/solar-coronal-inversion/">solar-coronal-inversion repository on github</a><a class="headerlink" href="#solar-coronal-inversion-repository-on-github" title="Permalink to this heading">¶</a></h1>
<p>Contact: Alin Paraschiv (arparaschiv&#64;ucar.edu)</p>
<section id="history-for-build-module">
<h2><strong>History for BUILD module:</strong><a class="headerlink" href="#history-for-build-module" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>ARP: 20210617 - initial release.</p></li>
<li><p>ARP: 20210827 - Added a Slurm enabled version of the script for batch jobs on RC systems.</p></li>
<li><p>ARP: 20210915 - Rewrote the thread scaling to allocate tasks uniformly across threads; Both interactive and batch scripts now can utilize RC Slurm capabilities. The interactive version can only use Slurm allocated resources inside interactive jobs. The batch dedicated version can utilize scratch directories; It copies final outputs in a user’s project directory after finalizing tasks.</p></li>
<li><p>ARP: 20221222 - Updated both scripts to fix an error with calculating the optimal heights that are scaled across available nodes.</p></li>
</ul>
</section>
<section id="scope">
<h2><strong>SCOPE:</strong><a class="headerlink" href="#scope" title="Permalink to this heading">¶</a></h2>
<p>This is a simple bash script implementation that launches separate parallel processes for building Stokes IQUV databases as part of the CLEDB_BUILD module.
Two versions are provisioned:</p>
<ol class="arabic simple">
<li><p><em><span class="xref myst">rundb_1line.sh</span></em>    (For local <strong>interactive</strong> runs; can be utilized inside slurm interactive environments too.)</p></li>
<li><p><em><span class="xref myst">rundb_1line_slurm.sh</span></em>    (For <strong>batch</strong> and/or headless runs.)</p></li>
</ol>
</section>
<section id="install-and-usage">
<h2><strong>INSTALL and USAGE:</strong><a class="headerlink" href="#install-and-usage" title="Permalink to this heading">¶</a></h2>
<ul>
<li><p>make sure the scripts are executable:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  chmod u+x rundb_1line.sh
  chmod u+x rundb_1line_slurm.sh
</pre></div>
</div>
</li>
<li><p>(Only on OSX) Install gnu-sed (See notes below):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  brew install gnu-sed
</pre></div>
</div>
</li>
<li><p>(Optional if needed) OSX might have issues with running executables (“cannot execute binary file”).
To fix try:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  xattr -d com.apple.quarantine /path/to/file
</pre></div>
</div>
</li>
<li><p>(Optional) for interactive jobs on RC systems, the correct modules may need to be preloaded in order for scripts to execute.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  module load slurm/blanca
  module load gcc/10.2.0                (gcc is preloaded automatically in the batch version of the script.)
</pre></div>
</div>
</li>
<li><p>run interactive jobs with (after starting the interactive node; see README_SLURM):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  ./rundb_1line.sh
</pre></div>
</div>
</li>
<li><p>run batch/headless jobs with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  sbatch rundb_1line_slurm.sh
</pre></div>
</div>
</li>
</ul>
</section>
<section id="notes">
<h2><strong>NOTES:</strong><a class="headerlink" href="#notes" title="Permalink to this heading">¶</a></h2>
<ul>
<li><p>The interactive <em><span class="xref myst">rundb_1line.sh</span></em> script requires two manual keyboard user inputs.</p>
<p>i. select how many CPU threads to use;</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  Hi 
  You have xx CPU threads available.
  How many to use?
</pre></div>
</div>
<p>ii. which ion/line to compute. Each ion/line will create its own subfolder in the directory structure to store computations.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  Please indicate the line to generate. Options are:
  1:    FE XIII 1074.7nm
  2:    FE XIII 1079.8nm
  3:    Si X    1430.1nm
  4:    Si IX   3934.3nm
</pre></div>
</div>
</li>
<li><p>The batch <em><span class="xref myst">rundb_1line_slurm.sh</span></em> script has no keyboard inputs, but has manually defined variables that control the ions to generate and system paths.</p></li>
<li><p>Most directory and file pointers are dynamically linked to the CLEDB distribution directory. Local runs should run without interference. Some directory/system containing variables are defined to be compatible with the CURC system (scratch, project, etc. dirs). These may need to be updated for different systems.</p></li>
<li><p>** NEWLY COMPLETED RUNS WILL DELETE/OVERWRITE PREVIOUSLY COMPUTED CALCULATIONS AND LOGS IN THE CORRESPONDENT SUBFOLDER**</p></li>
<li><p>The scripts are configured to produce one line database outputs. All atomic data for the four ions of interest along with the configuration files are available in the <em>config</em> directory. This setup selects the relevant inputs automatically.</p></li>
<li><p>Outside of the two batch scripts, the only user editable file is the <span class="xref myst">config/DB.INPUT</span> that configures the database number of calculations (parameter resolution).</p></li>
<li><p>Database output, header, and logs will be written in the correspondent ion sub-directory. Intermediary folders and files will be deleted upon completion. The logs are dynamically written and calculation status can be checked anytime with <em>tail</em>; e.g.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  tail BASHJOB_0.LOG 
</pre></div>
</div>
</li>
<li><p>The ./rundb scripts will wait for all thread tasks to finish before exiting.
Due to limitation in CPU process ID (PID) tracking, the user is not notified in order of threads finalizing, but in the order they were scheduled. e.g. if thread 2 finishes before thread 0, the user will find out only after thread 0 and thread 1 finish. A bug might manifest if a new unrelated task is scheduled with the same PID as one of the runs, but this should not occur in normal circumstances. If such a case occurs, a tail of the logs will verify that everything went well and scripts can be exited manually.</p></li>
<li><p>The number of Y-heights to calculate between the ymin and ymax ranges are not always a multiple of the number of CPU threads.
The scripts will efficiently scale the tasks on the available threads. If you request less tasks (via <span class="xref myst">DB.INPUT</span>) than threads (via keyboard or sbatch), the script will not utilize all pre-allocated resources.</p></li>
<li><p>The script heavily relies on the SED function.
SED has different implementations on Linux (GNU) vs mac (BSD) which makes commands not be directly correspondent. A function wrapper <em>SEDI</em> that disentangles GNU vs BSD syntax is provided in the scripts. OSX users need to install a gnu implementation of sed (gnu-sed) for the script to be portable between systems (via the gsed command).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  brew install gnu-sed
</pre></div>
</div>
</li>
<li><p>The script cuts and appends midline on the DB.INPUT file, to set the ymin and ymax ranges for each CPU thread.
The number of decimals for all variables and 3 spaces in between them need to be kept in the configuration file in order to not introduce bugs.</p></li>
<li><p>Executables (dbxxx) need to be build (from CLE) on the current architecture: ELF(linux) or Mach-O(OSX)
If non-correct executables are called a “cannot execute binary file” error is produced. Architecture can be checked with the <em>file</em> command. The configuration deduces the OS in use and selects and uses the proper dbxxx executable in each case, where both Darwin and LINUX executables exist. The linux executable has a CURC cross compiled executable compiled with gcc/10.2.0 for use in RC systems.</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">solar-coronal-inversion</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="synopsis.html">Synopsis and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_overview.html">Module Overview Schematic</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">solar-coronal-inversion repository on github</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#history-for-build-module"><strong>History for BUILD module:</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#scope"><strong>SCOPE:</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#install-and-usage"><strong>INSTALL and USAGE:</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#notes"><strong>NOTES:</strong></a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="module_overview.html" title="previous chapter">Module Overview Schematic</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Alin Paraschiv.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/README-RUNDB.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>